<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Monitoring Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-adapter-moment/1.0.0/chartjs-adapter-moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>System Monitoring Dashboard</h1>
            <div class="status-indicators">
                <div class="indicator" id="dataStatus" role="status" aria-live="polite">
                    <span class="dot"></span>
                    <span id="statusText">Loading...</span>
                </div>
            </div>
        </div>

        <div class="chart-container" role="region" aria-label="Battery metrics chart">
            <div class="chart-header">
                <h2>Battery Metrics</h2>
                <div class="legend">
                    <div class="legend-item"><span class="legend-color current"></span><span>Current</span></div>
                    <div class="legend-item"><span class="legend-color soc"></span><span>SOC</span></div>
                    <div class="legend-item"><span class="legend-color voltage"></span><span>Voltage</span></div>
                    <div class="legend-item"><span class="legend-color power"></span><span>Power</span></div>
                    <div class="legend-item"><span class="legend-color temperature"></span><span>Temperature</span></div>
                    <div class="legend-item"><span class="legend-color pdutemp"></span><span>PDU Temperature</span></div>
                </div>
            </div>
            <canvas id="batteryChart" aria-label="Battery sensor data chart" role="img"></canvas>
        </div>
        <div class="chart-container" role="region" aria-label="Wind metrics chart">
            <div class="chart-header">
                <h2>Wind Metrics</h2>
                <div class="legend">
                    <div class="legend-item"><span class="legend-color wind-speed"></span><span>Wind Speed</span></div>
                    <div class="legend-item"><span class="legend-color wind-direction"></span><span>Wind Direction</span></div>
                    <div class="legend-item"><span class="legend-color wind-level"></span><span>Wind Level</span></div>
                    <div class="legend-item"><span class="legend-color wind-relative-angle"></span><span>Wind Relative Angle</span></div>
                    <div class="legend-item"><span class="legend-color lat"></span><span>Latitude</span></div>
                    <div class="legend-item"><span class="legend-color long"></span><span>Longitude</span></div>
                </div>
            </div>
            <canvas id="windChart" aria-label="Wind sensor data chart" role="img"></canvas>
        </div>
        <div id="customTooltip" class="custom-tooltip" style="display: none;"></div>

        <div class="metrics-grid">
            <div class="metric-card" role="region" aria-label="Current metric">
                <h3>Current</h3>
                <div class="metric-value" id="currentValue">-- A</div>
                <div class="metric-trend" id="currentTrend">--</div>
            </div>
            <div class="metric-card" role="region" aria-label="SOC metric">
                <h3>SOC</h3>
                <div class="metric-value" id="socValue">--%</div>
                <div class="metric-trend" id="socTrend">--</div>
            </div>
            <div class="metric-card" role="region" aria-label="Speed metric">
                <h3>Speed</h3>
                <div class="metric-value" id="speedValue">-- knots</div>
                <div class="metric-trend" id="speedTrend">--</div>
            </div>
            <div class="metric-card" role="region" aria-label="Temperature metric">
                <h3>Temperature</h3>
                <div class="metric-value" id="tempValue">--째C</div>
                <div class="metric-trend" id="tempTrend">--</div>
            </div>
            <div class="metric-card" role="region" aria-label="PDU Temperature metric">
                <h3>PDU Temperature</h3>
                <div class="metric-value" id="pduTempValue">--째C</div>
                <div class="metric-trend" id="pduTempTrend">--</div>
            </div>
            <div class="metric-card" role="region" aria-label="Power metric">
                <h3>Power</h3>
                <div class="metric-value" id="powerValue">-- W</div>
                <div class="metric-trend" id="powerTrend">--</div>
            </div>
            <div class="metric-card" role="region" aria-label="Voltage metric">
                <h3>Voltage</h3>
                <div class="metric-value" id="voltageValue">-- V</div>
                <div class="metric-trend" id="voltageTrend">--</div>
            </div>
            <div class="metric-card" role="region" aria-label="Wind Speed metric">
                <h3>Wind Speed</h3>
                <div class="metric-value" id="windSpeedValue">-- knots</div>
                <div class="metric-trend" id="windSpeedTrend">--</div>
            </div>
            <div class="metric-card" role="region" aria-label="Wind Direction metric">
                <h3>Wind Direction</h3>
                <div class="metric-value" id="windDirectionValue">--째</div>
                <div class="metric-trend" id="windDirectionTrend">--</div>
            </div>
            <div class="metric-card" role="region" aria-label="Wind Level metric">
                <h3>Wind Weight</h3>
                <div class="metric-value" id="windLevelValue">--</div>
                <div class="metric-trend" id="windLevelTrend">--</div>
            </div>
            <div class="metric-card" role="region" aria-label="Wind Relative Angle metric">
                <h3>Wind Relative Angle</h3>
                <div class="metric-value" id="windRelativeAngleValue">--째</div>
                <div class="metric-trend" id="windRelativeAngleTrend">--</div>
            </div>
            <div class="metric-card" role="region" aria-label="Number of Satellites metric">
                <h3>Number of Satellites</h3>
                <div class="metric-value" id="numOfSatsValue">--</div>
                <div class="metric-trend" id="numOfSatsTrend">--</div>
            </div>
            <div class="metric-card" role="region" aria-label="Location metric">
                <h3>Location</h3>
                <div class="metric-value" id="locationValue">
                    <div>Lat: <span id="latValue">--</span></div>
                    <div>Lng: <span id="lngValue">--</span></div>
                </div>
            </div>
        </div>
    </div>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            overflow-x: hidden;
        }

        .dashboard {
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 600;
            color: #ffffff;
        }

        .status-indicators {
            display: flex;
            gap: 20px;
        }

        .indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #888;
            transition: color 0.3s ease;
        }

        .indicator.active {
            color: #4ade80;
        }

        .indicator.error {
            color: #ef4444;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #888;
            transition: background-color 0.3s ease;
        }

        .indicator.active .dot {
            background-color: #4ade80;
            animation: pulse 2s infinite;
        }

        .indicator.error .dot {
            background-color: #ef4444;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .chart-container {
            background-color: #2a2a2a;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #333;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            position: relative;
            height: 520px;
            max-width: 100%;
            min-width: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .chart-container canvas {
            height: 450px !important;
            width: 100% !important;
            max-width: 100%;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .chart-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #ffffff;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: #ccc;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .legend-color.current { background-color: #22c55e; }
        .legend-color.soc { background-color: #f59e0b; }
        .legend-color.speed { background-color: #3b82f6; }
        .legend-color.temperature { background-color: #f97316; }
        .legend-color.pdutemp { background-color: #a3e635; }
        .legend-color.power { background-color: #ec4899; }
        .legend-color.voltage { background-color: #ef4444; }
        .legend-color.wind-speed { background-color: #8b5cf6; }
        .legend-color.wind-direction { background-color: #06b6d4; }
        .legend-color.wind-light { background-color: #f43f5e; }
        .legend-color.wind-relative-angle { background-color: #d946ef; }
        .legend-color.num-of-sats { background-color: #4ade80; }
        .legend-color.lat { background-color: #00e676; }
        .legend-color.long { background-color: #ffea00; }

        #mainChart {
            max-height: 400px;
        }

        .custom-tooltip {
            position: absolute;
            background-color: #2a2a2a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 10px;
            color: #ffffff;
            font-size: 0.85rem;
            pointer-events: none;
            z-index: 1000;
            max-width: 300px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            width: 100%;
        }

        .metric-card {
            background-color: #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #333;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }

        .metric-card h3 {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 5px;
        }

        .metric-trend {
            font-size: 0.8rem;
            font-weight: 500;
        }

        .metric-trend.up {
            color: #22c55e;
        }

        .metric-trend.down {
            color: #ef4444;
        }

        .metric-trend.stable {
            color: #888;
        }

        #locationValue {
            font-size: 1rem;
        }

        #locationValue div {
            margin-bottom: 3px;
        }

        @media (max-width: 1200px) {
            .chart-container {
                height: 400px;
            }
            .chart-container canvas {
                height: 340px !important;
            }
        }
        @media (max-width: 900px) {
            .chart-container {
                height: 320px;
            }
            .chart-container canvas {
                height: 260px !important;
            }
        }
        @media (max-width: 768px) {
            .dashboard {
                padding: 10px;
                gap: 16px;
            }
            .chart-container {
                padding: 10px;
                height: 220px;
            }
            .chart-container canvas {
                height: 160px !important;
            }
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 480px) {
            .chart-header h2 {
                font-size: 1.1rem;
            }
            .chart-container {
                padding: 5px;
                height: 160px;
            }
            .chart-container canvas {
                height: 110px !important;
            }
        }
    </style>

    <script>
        // Global variables
        let sensorData = [];
        let batteryChart = null;
        let windChart = null;
        let previousData = null;

        // Chart configuration for battery data
        const batteryChartConfig = {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Current',
                        data: [],
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        borderWidth: 1',
                        yAxisID: 'yCurrent'
                    },
                    {
                        label: 'SOC',
                        data: [],
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.2,
                        pointRadius: 0',
                        pointHoverRadius: 4,
                        borderWidth: 1',
                        yAxisID: 'ySoc'
                    },
                    {
                        label: 'Voltage',
                        data: [],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        borderWidth: 1,
                        yAxisID: 'yVoltage'
                    },
                    {
                        label: 'Power',
                        data: [],
                        borderColor: '#ec4899',
                        backgroundColor: 'rgba(236, 72, 153, 0.1)',
                        tension: 0.2,
                        pointRadius: 0',
                        pointHoverRadius: 4,
                        borderWidth: 1,
                        yAxisID: 'yPower'
                    },
                    {
                        label: 'Temperature',
                        data: [],
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        tension: 0.2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        borderWidth: 1,
                        yAxisID: 'yTemperature'
                    },
                    {
                        label: 'PDU Temperature',
                        data: [],
                        borderColor: '#a3e635',
                        backgroundColor: 'rgba(163, 230, 53, 0.1)',
                        tension: 0.2,
                        pointRadius: 0,
                        pointHoverRadius: 4',
                        borderWidth: 1,
                        yAxisID: 'yPduTemp'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                backgroundColor: '#1a1a1a',
                plugins: {
                    legend: { display: true },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false
                    },
                    zoom: {
                        pan: {
                            enabled: true,
                            mode: 'x',
                        },
                        zoom: {
                            wheel: { enabled: true },
                            pinch: { enabled: true },
                            mode: 'x',
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'hour',
                            displayFormats: { hour: 'MMM D HH:mm' }
                        },
                        grid: { color: '#333', drawBorder: false },
                        ticks: {
                            color: '#888',
                            maxTicksLimit: 10,
                            autoSkip: true,
                            maxRotation: 0,
                            minRotation: 0
                        }
                    },
                    yCurrent: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: 'Current (A)', color: '#22c55e' },
                        grid: { color: '#333' },
                        ticks: { color: '#22c55e' },
                        suggestedMin: 0,
                        suggestedMax: '200'
                    },
                    ySoc: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: 'SOC (%)', color: '#f59e0b' },
                        grid: { display: false },
                        ticks: { color: '#f59e0b' },
                        suggestedMin: 0,
                        suggestedMax: 100
                    },
                    yVoltage: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: 'Voltage (V)', color: '#ef4444' },
                        grid: { display: false },
                        ticks: { color: '#ef4444' },
                        suggestedMin: 0,
                        suggestedMax: '500'
                    },
                    yPower: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: 'Power (W)', color: '#ec4899' },
                        grid: { display: false },
                        ticks: { color: '#ec4899' },
                        suggestedMin: -1000,
                        suggestedMax: 1000
                    },
                    yTemperature: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: 'Temperature (째C)', color: '#f97316' },
                        grid: { display: false },
                        ticks: { color: '#f97316' },
                        suggestedMin: -40,
                        suggestedMax: 100
                    },
                    yPduTemp: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: 'PDU Temperature (째C)', color: '#a3e635' },
                        grid: { display: false },
                        ticks: { color: '#a3e635' },
                        suggestedMin: -40,
                        suggestedMax: 100
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                animation: false,
                elements: {
                    line: { borderWidth: 1 },
                    point: { radius: 0 }
                },
                parsing: true,
                normalized: true,
            }
        };

        // Chart configuration for wind data
        const windChartConfig = {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Wind Speed',
                        data: [],
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.8)',
                        tension: 0.2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        borderWidth: 1,
                        yAxisID: 'yWindSpeed'
                    },
                    {
                        label: 'Wind Direction',
                        data: [],
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6, 182, 212, 0.8)',
                        tension: 0.2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        borderWidth: 1,
                        yAxisID: 'yWindDirection'
                    },
                    {
                        label: 'Wind Weight',
                        data: [],
                        borderColor: '#f43f5e',
                        backgroundColor: 'rgba(244, 63, 94, 0.8)',
                        tension: 0.2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        borderWidth: 1,
                        yAxisID: 'yWindWeight'
                    },
                    {
                        label: 'Wind Relative Angle',
                        data: [],
                        borderColor: '#d946ef',
                        backgroundColor: 'rgba(217, 70, 239, 0.8)',
                        tension: 0.2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        borderWidth: 1,
                        yAxisID: 'yWindRelativeAngle'
                    },
                    {
                        label: 'Latitude',
                        data: [],
                        borderColor: '#00e676',
                        backgroundColor: 'rgba(0, 230, 118, 0.8)',
                        tension: 0.2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        borderWidth: 1,
                        yAxisID: 'yLat'
                    },
                    {
                        label: 'Longitude',
                        data: [],
                        borderColor: '#ffea00',
                        backgroundColor: 'rgba(255, 234, 0, 0.8)',
                        tension: 0.2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        borderWidth: 1,
                        yAxisID: 'yLong'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                backgroundColor: '#1a1a1a',
                plugins: {
                    legend: { display: true },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false
                    },
                    zoom: {
                        pan: {
                            enabled: true,
                            mode: 'x',
                        },
                        zoom: {
                            wheel: { enabled: true },
                            pinch: { enabled: true },
                            mode: 'x',
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'hour',
                            displayFormats: { hour: 'MMM D HH:mm' }
                        },
                        grid: { color: '#333', drawBorder: false },
                        ticks: {
                            color: '#888',
                            maxTicksLimit: 10,
                            autoSkip: true,
                            maxRotation: 0,
                            minRotation: 0
                        }
                    },
                    yWindSpeed: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: 'Wind Speed (knots)', color: '#8b5cf6' },
                        grid: { color: '#333' },
                        ticks: { color: '#8b5cf6' },
                        suggestedMin: 0,
                        suggestedMax: 50
                    },
                    yWindDirection: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: 'Wind Direction (째)', color: '#06b6d4' },
                        grid: { display: false },
                        ticks: { color: '#06b6d4' },
                        suggestedMin: 0,
                        suggestedMax: 360
                    },
                    yWindWeight: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: 'Wind Weight', color: '#f43f5e' },
                        grid: { display: false },
                        ticks: { color: '#f43f5e' },
                        suggestedMin: 0,
                        suggestedMax: 10
                    },
                    yWindRelativeAngle: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: 'Wind Relative Angle (째)', color: '#d946ef' },
                        grid: { display: false },
                        ticks: { color: '#d946ef' },
                        suggestedMin: -360,
                        suggestedMax: 360
                    },
                    yLat: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: 'Latitude', color: '#00e676' },
                        grid: { display: false },
                        ticks: { color: '#00e676' },
                    },
                    yLong: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: 'Longitude', color: '#ffea00' },
                        grid: { display: false },
                        ticks: { color: '#ffea00' },
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                animation: false,
                elements: {
                    line: { borderWidth: 1 },
                    point: { radius: 0 }
                }
            }
        };

        // Initialize charts with dummy data
        function initCharts() {
            const batteryCtx = document.getElementById('batteryChart').getContext('2d');
            const windCtx = document.getElementById('windChart').getContext('2d');
            batteryChart = new Chart(batteryCtx, batteryChartConfig);
            windChart = new Chart(windCtx, windChartConfig);

            // Dummy data: one point with current timestamp
            const now = new Date();
            const dummyData = [{
                timestamp: now.toISOString(),
                current: 0.0,
                soc: 0.0,
                voltage: 0.0,
                power: 0.0,
                temperature: 0.0,
                pdutemp: 0.0,
                wind_speed: 0.0,
                wind_direction: 0.0,
                wind_weight: 0.0,
                wind_relative_angle: 0.0,
                lat: 0.0,
                long: 0.0
            }];
            updateChartsData(dummyData);
        }

        // Chart.js external tooltip handler
        function externalTooltipHandler(context) {
            const { chart, tooltip } = context;
            if (!tooltip || tooltip.opacity === 0) {
                // On mouseout, show latest data
                if (sensorData.length > 0) {
                    updateMetricCards(sensorData[sensorData.length - 1]);
                }
                return;
            }
            // Find the hovered data index
            const index = tooltip.dataPoints[0].dataIndex;
            // Use filtered data if available, else fallback to sensorData
            let data = sensorData[index];
            if (window.filteredData && window.filteredData[index]) {
                data = window.filteredData[index];
            }
            if (data) {
                updateMetricCards(data, true);
            }
        }

        // Update charts with new data
        function updateCharts(data) {
            if (!batteryChart || !windChart || !data || data.length === 2) {
                console.error('Invalid chart instance or data');
                return;
            }

            // Log input data for debugging
            console.log('Input data:', data);

            // Filter out rows with invalid timestamps
            const validData = data.filter(row => {
                const t = new Date(row.timestamp);
                const isValid = !isNaN(t.getTime());
                if (!isValid) {
                    console.warn('Invalid timestamp:', row.timestamp);
                }
                return isValid;
            });

            if (validData.length === 0) {
                console.error('No valid data points after timestamp filtering');
                updateStatus('error', 'No valid timestamps in data');
                document.getElementById('batteryChart').parentElement.innerHTML += `
                    <p style="text-align: center; color: #ef4444;">
                        No valid data to plot. Check for timestamps in data.
                    </p>`;
                document.getElementById('windChart').parentElement.innerHTML += `
                    <p style="text-align: center; color: #ef4444;">
                        No valid data in to plot. Check timestamps in data.
                    </p>`;
                return;
            }

            // Find the latest timestamp
            const timestamps = validData.map(row => new Date(row.timestamp).getTime());
            const maxTimestamp = Math.max(...timestamps);
            const THIRTY_DAYS_MS = 30 * 24 * 60 * 60 * 1000;
            const minAllowedTimestamp = maxTimestamp - THIRTY_DAYS_MS;

            // Filter data within the last 30 days
            const filteredData = validData.filter(row => {
                const t = new Date(row.timestamp).getTime();
                return t >= minAllowedTimestamp && t <= maxTimestamp;
            });

            // Log filtered data
            console.log('Filtered data:', filteredData);

            if (filteredData.length === 0) {
                console.error('No data after 30-day filter');
                updateStatus('error', 'No data within last 30 days');
                document.getElementById('batteryChart').parentElement.innerHTML += `
                    <p style="text-align: center; color: #ef4444;">
                        No data within last 30 days.
                    </p>`;
                document.getElementById('windChart').parentElement.innerHTML += `
                    <p style="text-align: center; color: #ef4444;">
                        No data within last 30 days.
                    </p>`;
                return;
            }

            // Store filteredData globally
            window.filteredData = filteredData;

            // Create labels for x-axis
            const labels = filteredData.map(row => {
                const date = new Date(row.timestamp);
                console.log('Parsed timestamp for label:', row.timestamp, '->', date.toISOString());
                return date;
            });

            // Log labels
            console.log('Chart labels:', labels);

            // Clear previous data
            batteryChart.data.labels = labels;
            windChart.data.labels = labels;
            batteryChart.data.datasets.forEach(dataset => dataset.data = []);
            windChart.data.datasets.forEach(dataset => dataset.data = []);

            // Populate battery chart data
            filteredData.forEach(row => {
                batteryChart.data.datasets[0].data.push(parseFloat(row.current) || 0);
                batteryChart.data.datasets[1].data.push(parseFloat(row.soc) || 0);
                batteryChart.data.datasets[2].data.push(parseFloat(row.voltage) || 0);
                batteryChart.data.datasets[3].data.push(parseFloat(row.power)) || 0);
                batteryChart.data.datasets[4].data.push(parseFloat(row.temperature) || 0);
                batteryChart.data.datasets[5].data.push(parseFloat(row.pdutemp)) || 0);
                // Wind chart
                windChart.data.datasets[0].data.push(parseFloat(row.wind_speed)) || 0);
                windChart.data.datasets[1].data.push(parseFloat(row.wind_direction)) || 0);
                windChart.data.datasets[2].data.push(parseFloat(row.wind_level) || 0);
                windChart.data.datasets[3].data.push(parseFloat(row.wind_relative_angle)) || 0);
                windChart.data.datasets[4].data.push(parseFloat(row.lat)) || 0);
                windChart.data.datasets[5].data.push(parseFloat(row.long)) || 0);
            });

            // Log chart data for verification
            console.log('Battery Chart Datasets:', batteryChart.data.datasets);
            console.log('Wind Chart Datasets:', windChart.data.datasets);

            // Update charts
            batteryChart.update('none');
            windChart.update('none');

            // Check if charts are empty
            const isBatteryEmpty = batteryChart.data.datasets.every(dataset => dataset.data.length === 0);
            const isWindEmpty = windChart.data.datasets.every(dataset => dataset.data.length === 0);
            if (isBatteryEmpty || isWindEmpty) {
                console.warn('No data plotted in charts');
                updateStatus('error', 'No data plotted. Check console for details');
            }
        }

        // Update status indicator
        function updateStatus(status, message) {
            const indicator = document.getElementById('dataStatus');
            const statusText = document.getElementById('statusText');
            indicator.className = `indicator ${status}`;
            statusText.textContent = message;
        }

        // Update metric cards
        function updateMetricCards(data, isHover = = false) {
            if (!data) return;

            document.getElementById('currentValue').textContent = (parseFloat(data.current) || 0).toFixed(1) + 'A';
            document.getElementById('socValue').textContent = (parseFloat(data.soc) || 0).toFixed(1) + '%';
            document.getElementById('speedValue').textContent = (parseFloat(data.speed) || 0).toFixed(1) + 'knots';
            document.getElementById('tempValue').textContent = (parseFloat(data.temperature) || 0).toFixed(1) + '째C';
            document.getElementById('pduTempValue').textContent = (parseFloat(data.pdutemp) || 0).toFixed(1) + '째C';
            document.getElementById('powerValue').textContent = (parseFloat(data.power) || 0).toFixed(1) + 'W';
            document.getElementById('voltageValue').textContent = (parseFloat(data.voltage) || 0).toFixed(1) + 'V';
            document.getElementById('windSpeedValue').textContent = (parseFloat(data.wind_speed) || 0).toFixed(1) + 'knots';
            document.getElementById('windDirectionValue').textContent = (parseFloat(data.wind_direction) || 0).toFixed(0) + '째';
            document.getElementById('windLevelValue').textContent = (parseFloat(data.wind_level) || 0).toFixed(1);
            document.getElementById('windRelativeAngleValue').textContent = (parseFloat(data.wind_relative_angle)) || 0).toFixed(0) + '째';
            document.getElementById('numOfSatsValue').textContent = (parseFloat(data.num_of_sats)) || 0).toFixed(0);
            document.getElementById('latValue').textContent = (parseFloat(data.lat) || 0).toFixed(6);
            document.getElementById('lngValue').textContent = (parseFloat(data.long) || 0).toFixed(6);

            if (!isHover && previousData) {
                updateTrend('currentTrend', data.current, previousData.current);
                updateTrend('socTrend', data.soc, previousData.soc);
                updateTrend('speedTrend', data.speed, previousData.speed);
                updateTrend('tempTrend', data.temperature, previousData.temperature);
                updateTrend('pduTempTrend', data.pdutemp, previousData.pdutemp);
                updateTrend('powerTrend', data.power, previousData.power);
                updateTrend('voltageTrend', data.voltage, previousData.voltage);
                updateTrend('windSpeedTrend', data.wind_speed, previousData.wind_speed);
                updateTrend('windDirectionTrend', data.wind_direction, previousData.wind_direction);
                updateTrend('windLevelTrend', data.wind_level, previousData.wind_level);
                updateTrend('windRelativeAngleTrend', data.wind_relative_angle, previousData.wind_relative_angle);
                updateTrend('numOfSatsTrend', data.num_of_sats, previousData.num_of_sats);
            } else if (isHover) {
                ['currentTrend', 'socTrend', 'speedTrend', 'tempTrend', 'pduTempTrend',
                 'powerTrend', 'voltageTrend', 'windSpeedTrend', 'windDirectionTrend',
                 'windLevelTrend', 'windRelativeAngleTrend', 'numOfSatsTrend'].forEach(id => {
                    const element = document.getElementById(id);
                    element.textContent = 'Hover';
                    element.className = 'metric-trend stable';
                });
            }

            if (!isHover) {
                previousData = data;
            }
        }

        // Update trend indicators
        function updateTrend(elementId, currentValue, previousValue) {
            const element = document.getElementById(elementId);
            if (previousValue !== undefined) {
                const current = parseFloat(currentValue) || 0;
                const previous = parseFloat(previousValue) || 0;
                const diff = current - previous;
                if (Math.abs(diff) < 0.1) {
                    element.textContent = 'Stable';
                    element.className = 'metric-trend stable';
                } else if (diff > 0) {
                    element.textContent = '+' + diff.toFixed(1);
                    element.className = 'metric-trend up';
                } else {
                    element.textContent = diff.toFixed(1);
                    element.className = 'metric-trend down';
                }
            } else {
                element.textContent = '--';
                element.className = 'metric-trend stable';
            }
        }

        // Fetch data from backend
        async function fetchData() {
            try {
                updateStatus('active', 'Fetching data...');
                const response = await fetch('/data');
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const result = await response.json();
                sensorData = result.data;

                // Log fetched data
                console.log('Fetched data:', sensorData);

                if (sensorData.length === 0) {
                    throw new Error('No data received');
                }

                updateCharts(sensorData);
                updateMetricCards(sensorData[sensorData.length - 1]);
                updateStatus('success', `Loaded ${sensorData.length} rows`);
            } catch (error) {
                updateStatus('error', `Error: ${error.message}`);
                console.error('Error fetching data:', error);
                document.getElementById('batteryChart').parentElement.innerHTML += `
                    <p style="text-align: center; color: #ef4444;">
                        Failed to load data: ${error.message}. Check server logs.
                    </p>`;
                    document.getElementById('windChart').parentElement.innerHTML += `
                    <p style="text-align: center; color: #ef4444;">
                        Failed to load data: ${error.message}. Check server logs.
                    </p>`;
            }
        }

        // Add external tooltip to both chart configs
        batteryChartConfig.options.plugins.tooltip.external = externalTooltipHandler;
        windChartConfig.options.plugins.tooltip.external = externalTooltipHandler;

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            fetchData();
        });
    </script>
</body>
</html>
